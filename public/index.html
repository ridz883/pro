<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Ridzkey Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-6">
    <div class="max-w-md mx-auto bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-700 mt-10">
        <h1 class="text-xl font-bold text-center text-blue-400 mb-6">ALL RIDZKEY PRO</h1>
        <input type="text" id="urlInput" placeholder="Tempel link video..." class="w-full p-4 bg-slate-900 border border-slate-700 rounded-2xl mb-4 outline-none">
        <button onclick="downloadStart()" id="btn" class="w-full bg-blue-600 py-4 rounded-2xl font-bold active:scale-95 transition-all">UNDUH VIDEO</button>
        
        <div id="pContainer" class="hidden mt-6">
            <div class="flex justify-between text-[10px] mb-1">
                <span id="pStatus">Menyiapkan...</span>
                <span id="pPercent">0%</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="pBar" class="bg-blue-500 h-full w-0 transition-all"></div>
            </div>
        </div>
    </div>

    <script>
        async function downloadStart() {
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('btn');
            const pContainer = document.getElementById('pContainer');
            const pBar = document.getElementById('pBar');
            const pPercent = document.getElementById('pPercent');
            const pStatus = document.getElementById('pStatus');

            if(!url) return;
            btn.disabled = true;
            pContainer.classList.remove('hidden');

            try {
                // Step 1: Ambil Link Langsung
                pStatus.innerText = "Menganalisis link...";
                const res = await fetch(`/get-link?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                if(!data.status) throw new Error(data.message);

                // Step 2: Download di Sisi Client (Akurat 100%)
                pStatus.innerText = "Mengunduh file...";
                const mediaResponse = await fetch(data.downloadUrl);
                const reader = mediaResponse.body.getReader();
                const contentLength = +mediaResponse.headers.get('Content-Length');
                
                let receivedLength = 0;
                let chunks = [];
                
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    if(contentLength) {
                        const step = Math.round((receivedLength / contentLength) * 100);
                        pBar.style.width = step + '%';
                        pPercent.innerText = step + '%';
                    }
                }

                // Step 3: Simpan File
                pStatus.innerText = "Menyimpan ke HP...";
                const blob = new Blob(chunks);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${data.title}.mp4`;
                a.click();
                
                pStatus.innerText = "Selesai!";
            } catch (e) {
                alert("Gagal: " + e.message);
                pStatus.innerText = "Terjadi kesalahan.";
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
